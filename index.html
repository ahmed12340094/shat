const express=require("express"),http=require("http"),{Server:IO}=require("socket.io"),bcrypt=require("bcrypt"),cookieParser=require("cookie-parser"),{v4:uuid}=require("uuid");const PORT=process.env.PORT||3000,app=express(),srv=http.createServer(app),io=new IO(srv,{pingTimeout:3e4});app.use(express.json());app.use(cookieParser("s"));// db
const users={},sockets={},chats={};function auth(r,e,n){const u=r.signedCookies.u;if(u&&users[u]){r.user=users[u];r.username=u}n()}app.post("/api/register",async(r,e)=>{let{username:u,password:p,gender:g}=r.body;if(users[u])return e.status(409).json({err:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯"});users[u]={passHash:await bcrypt.hash(p,10),gender:g,role:"user",bio:"",avatar:`https://api.dicebear.com/8.x/initials/svg?seed=${u}`,friends:new Set};if(Object.keys(users).length===1)users[u].role="owner";e.cookie("u",u,{signed:!0});e.json({ok:!0,role:users[u].role})});app.post("/api/login",async(r,e)=>{let{username:u,password:p}=r.body,o=users[u];if(!o)return e.status(404).json({err:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…"});if(!(await bcrypt.compare(p,o.passHash)))return e.status(401).json({err:"ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"});e.cookie("u",u,{signed:!0});e.json({ok:!0,role:o.role})});app.post("/api/logout",auth,(r,e)=>{e.clearCookie("u");e.json({ok:!0})});app.get("/api/me",auth,(r,e)=>{if(!r.user)return e.status(401).json({err:"ØºÙŠØ± Ù…Ø³Ø¬Ù„"});let u=r.user;e.json({username:r.username,role:u.role,gender:u.gender,bio:u.bio,avatar:u.avatar,friends:[...u.friends]})});app.get("/api/search",auth,(r,e)=>{let q=(r.query.q||"").toLowerCase();e.json(Object.keys(users).filter(u=>u.toLowerCase().includes(q)).slice(0,20))});app.post("/api/add-friend",auth,(r,e)=>{let{friend:f}=r.body;if(!users[f])return e.status(404).json({err:"Ù„Ø§ ÙŠÙˆØ¬Ø¯"});users[r.username].friends.add(f);users[f].friends.add(r.username);e.json({ok:!0})});app.post("/api/gift-gold",auth,(r,e)=>{if(r.user.role!=="owner")return e.status(403).json({err:"Ù„Ù„Ù…Ø§Ù„Ùƒ"});let{target:t}=r.body;if(!users[t])return e.status(404).json({err:"Ù„Ø§"});users[t].role="gold";e.json({ok:!0})});app.post("/api/ban",auth,(r,e)=>{if(r.user.role!=="owner")return e.status(403).json({err:"Ù„Ù„Ù…Ø§Ù„Ùƒ"});let{target:t}=r.body;delete users[t];e.json({ok:!0})});io.on("connection",s=>{s.on("hello",u=>{sockets[s.id]=u});s.on("pm",({to:t,txt:x})=>{let k=[t,sockets[s.id]].sort().join("|");(chats[k]??=[]).push({from:sockets[s.id],to:t,txt:x});let id=Object.keys(sockets).find(i=>sockets[i]===t);id&&io.to(id).emit("pm",{from:sockets[s.id],txt:x})});s.on("rtc-signal",d=>s.to(d.room).emit("rtc-signal",d));s.on("join-room",({room:r,user:u})=>{s.join(r);s.to(r).emit("user-joined",u);s.on("disconnect",()=>s.to(r).emit("user-left",u))});s.on("disconnect",()=>delete sockets[s.id])});app.get("*",(_,e)=>e.send(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Ø´Ø§ØªÙ†Ù‡</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet"><style>body{margin:0;font-family:'Cairo',sans-serif;background:#000;color:#fff;direction:rtl;text-align:center}header{background:#b30000;padding:.7rem;font-size:1.4rem}section{max-width:800px;margin:1.5rem auto;background:#111;border-radius:10px;padding:1rem}input,select,textarea,button{font-family:'Cairo',sans-serif;border:none;border-radius:6px;padding:.6rem;margin:.3rem;width:90%;max-width:350px}button{background:#b30000;color:#fff;cursor:pointer}.hidden{display:none}.friend{background:#222;padding:.4rem;margin:.2rem;border-radius:6px;cursor:pointer}.friend.sel{background:#b30000}.msg{background:#222;padding:.4rem;margin:.2rem;border-radius:6px}.msg.me{background:#4b002e;text-align:left}#voiceArea{background:#111;padding:.5rem;border-radius:8px;margin-top:.5rem}</style></head><body><header id="hdr">Ø´Ø§ØªÙ†Ù‡</header><section id="landing"><h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h2><button onclick="sb('g')">Ø²Ø§Ø¦Ø±</button><button onclick="sb('l')">Ø¯Ø®ÙˆÙ„</button><button onclick="sb('r')">ØªØ³Ø¬ÙŠÙ„</button></section><section id="g" class="hidden"><input id="gName" placeholder="Ø§Ø³Ù…Ùƒ"><button onclick="gl()">Ø¯Ø®ÙˆÙ„</button></section><section id="l" class="hidden"><input id="lUser" placeholder="Ø§Ø³Ù…"><input id="lPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"><button onclick="lo()">Ø¯Ø®ÙˆÙ„</button></section><section id="r" class="hidden"><input id="rUser" placeholder="Ø§Ø³Ù…"><input id="rPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"><button onclick="re()">ØªØ³Ø¬ÙŠÙ„</button></section><section id="chat" class="hidden"><div id="friends" style="max-height:150px;overflow:auto"></div><textarea id="msg" rows="2"></textarea><button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button><div id="msgs" style="max-height:220px;overflow:auto;margin-top:.5rem"></div><input id="search" placeholder="Ø¨Ø­Ø«..." oninput="srch()"><div id="res"></div><input id="room" placeholder="ØºØ±ÙØ©"><button onclick="join()">ØµÙˆØª</button><button id="mic" class="hidden" onclick="mic()">ğŸ™ï¸</button><div id="voiceArea" class="hidden"><span id="users"></span></div><button onclick="lo2()">Ø®Ø±ÙˆØ¬</button></section><script src="/socket.io/socket.io.js"></script><script>const s=io();let me=null,cur=null,stream=null,pc={},room=null;const q=x=>document.querySelector(x);function sb(id){document.querySelectorAll('section').forEach(e=>e.classList.add('hidden'));q('#'+id).classList.remove('hidden')}function gl(){me=q('#gName').value;start()}async function api(p,d){return fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).then(r=>r.json())}async function lo(){let d=await api('/api/login',{username:q('#lUser').value,password:q('#lPass').value});d.ok&&start()}async function re(){let d=await api('/api/register',{username:q('#rUser').value,password:q('#rPass').value,gender:'M'});d.ok&&start()}async function start(){let r=await fetch('/api/me');if(r.ok){let d=await r.json();me=d.username;q('#friends').innerHTML=d.friends.map(f=>'<div class=friend onclick=sel(this,"'+f+'")>'+f+'</div>').join('')}else{}q('#landing').classList.add('hidden');q('#chat').classList.remove('hidden');q('#hdr').textContent='Ø´Ø§ØªÙ†Ù‡ - '+me;s.emit('hello',me)}function sel(el,u){cur=u;document.querySelectorAll('.friend').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');q('#msgs').innerHTML=''}function send(){let t=q('#msg').value.trim();if(!t||!cur)return;s.emit('pm',{to:cur,txt:t});append(t,'me');q('#msg').value=''}s.on('pm',d=>{if(d.from===cur)append(d.txt)});function append(t,c=''){let d=document.createElement('div');d.className='msg '+c;d.textContent=t;q('#msgs').appendChild(d);q('#msgs').scrollTop=q('#msgs').scrollHeight}async function srch(){let v=q('#search').value.trim();if(!v)return q('#res').textContent='';let r=await fetch('/api/search?q='+encodeURIComponent(v)).then(r=>r.json());q('#res').innerHTML=r.map(u=>'<button onclick="add(\''+u+'\')">Ø£Ø¶Ù '+u+'</button>').join('')}async function add(u){await api('/api/add-friend',{friend:u});location.reload()}function lo2(){api('/api/logout',{}).then(()=>location.reload())}async function join(){room=q('#room').value||'main';s.emit('join-room',{room,user:me});if(!stream)stream=await navigator.mediaDevices.getUserMedia({audio:true});q('#mic').classList.remove('hidden');q('#voiceArea').classList.remove('hidden');addPeer(me)}function addPeer(u){if(pc[u]||u===me)return;let peer=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});pc[u]=peer;stream.getTracks().forEach(t=>peer.addTrack(t,stream));peer.onicecandidate=e=>e.candidate&&s.emit('rtc-signal',{room,from:me,to:u,sig:{candidate:e.candidate}});peer.onnegotiationneeded=async()=>{let off=await peer.createOffer();await peer.setLocalDescription(off);s.emit('rtc-signal',{room,from:me,to:u,sig:{desc:peer.localDescription}})};update()}function update(){q('#users').textContent=Object.keys(pc).join(', ')}s.on('rtc-signal',async d=>{if(d.from===me)return;if(!pc[d.from])addPeer(d.from);let peer=pc[d.from];if(d.sig.desc){await peer.setRemoteDescription(d.sig.desc);if(d.sig.desc.type==='offer'){let ans=await peer.createAnswer();await peer.setLocalDescription(ans);s.emit('rtc-signal',{room,from:me,to:d.from,sig:{desc:peer.localDescription}})}}if(d.sig.candidate)await peer.addIceCandidate(d.sig.candidate)});s.on('user-joined',addPeer);s.on('user-left',u=>{if(pc[u]){pc[u].close();delete pc[u];update()}});function mic(){stream.getAudioTracks()[0].enabled=!stream.getAudioTracks()[0].enabled}</script></body></html>`));srv.listen(PORT,()=>console.log("run "+PORT));
